# é£ç§‹é€šè®¯é¡¹ç›® - ä»£ç é‡æ„åˆ†æä¸ä¼˜åŒ–è®¡åˆ’

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

**é¡¹ç›®åç§°**: é£ç§‹é€šè®¯ (Feiqiu Communication)  
**æŠ€æœ¯æ ˆ**: Tauri 2.0 + Rust (åç«¯) + React + TypeScript + Zustand (å‰ç«¯)  
**åˆ†ææ—¶é—´**: 2026-02-01  
**åˆ†æèŒƒå›´**: åç«¯ 78 ä¸ª Rust æ–‡ä»¶ + å‰ç«¯ 53 ä¸ª TypeScript/TSX æ–‡ä»¶

---

## ğŸ—ï¸ ä¸€ã€æ¶æ„åˆ†æ

### 1.1 åç«¯æ¶æ„ (Rust/Tauri)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é£ç§‹é€šè®¯åç«¯æ¶æ„                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  main.rs     â”‚ â† åº”ç”¨å…¥å£ã€åˆå§‹åŒ–ã€Tauriå‘½ä»¤æ³¨å†Œ           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚         â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   IPC å±‚     â”‚â”€â”€â”€â”€â”‚   Tauri      â”‚ â† å‰ç«¯é€šä¿¡æ¥å£         â”‚
â”‚  â”‚ (ipc/*.rs)   â”‚    â”‚   Commands   â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  ä¸šåŠ¡é€»è¾‘å±‚   â”‚â”€â”€â”€â”€â”‚  äº‹ä»¶æ€»çº¿    â”‚ â† crossbeam-channel   â”‚
â”‚  â”‚ (core/*)     â”‚    â”‚ (event/bus)  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  åè®®å±‚      â”‚â”€â”€â”€â”€â”‚ FeiQ/IPMsg   â”‚ â† åŒåè®®æ”¯æŒ           â”‚
â”‚  â”‚(network/feiq)â”‚    â”‚  åè®®è§£æ     â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  ç½‘ç»œå±‚      â”‚â”€â”€â”€â”€â”‚   UDP        â”‚ â† ç«¯å£2425å¹¿æ’­         â”‚
â”‚  â”‚(network/udp) â”‚    â”‚  Socket      â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  æ•°æ®åº“å±‚    â”‚â”€â”€â”€â”€â”‚  SQLite      â”‚ â† SeaORM ORM          â”‚
â”‚  â”‚(database/*)  â”‚    â”‚  + SeaORM    â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¶æ„è¯„ä»·**: â­â­â­â­â˜† (4/5)

- âœ… **åˆ†å±‚æ¸…æ™°**: IPCâ†’ä¸šåŠ¡â†’åè®®â†’ç½‘ç»œâ†’æ•°æ®åº“ï¼ŒèŒè´£è¾¹ç•Œæ˜ç¡®
- âœ… **äº‹ä»¶é©±åŠ¨**: å…¨å±€äº‹ä»¶æ€»çº¿(crossbeam-channel)è§£è€¦ç»„ä»¶
- âœ… **åŒåè®®æ”¯æŒ**: FeiQ/IPMsg è‡ªåŠ¨æ£€æµ‹
- âš ï¸ **å¾…æ”¹è¿›**: éƒ¨åˆ†æ¨¡å—è¿‡å¤§ã€é”™è¯¯å¤„ç†ä¸ä¸€è‡´ã€ç±»å‹è½¬æ¢é‡å¤

### 1.2 å‰ç«¯æ¶æ„ (React/TypeScript)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é£ç§‹é€šè®¯å‰ç«¯æ¶æ„                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    App.tsx                               â”‚â”‚
â”‚  â”‚               (åº”ç”¨æ ¹ç»„ä»¶)                               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                       â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              MainLayout.tsx                              â”‚â”‚
â”‚  â”‚         (ä¸‰æ å¸ƒå±€ï¼šä¼šè¯|é€šè®¯å½•|èŠå¤©)                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚             â”‚              â”‚                â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ SessionList   â”‚ â”‚  ContactList   â”‚ â”‚  ChatWindow   â”‚     â”‚
â”‚  â”‚ (ä¼šè¯åˆ—è¡¨)     â”‚ â”‚  (é€šè®¯å½•)       â”‚ â”‚  (èŠå¤©çª—å£)   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    çŠ¶æ€ç®¡ç†å±‚ (Zustand)                   â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ userStore.ts â”‚ chatStore.ts â”‚ groupStore.ts              â”‚â”‚
â”‚  â”‚ (ç”¨æˆ·çŠ¶æ€)   â”‚ (èŠå¤©çŠ¶æ€)   â”‚ (ç¾¤ç»„çŠ¶æ€)                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    æœåŠ¡å±‚ (IPC å°è£…)                      â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ ipc/chat.ts  â”‚ ipc/contact.tsâ”‚ ipc/file.ts               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    è‡ªå®šä¹‰ Hooks                          â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ useChat.ts   â”‚ useUser.ts   â”‚ useContact.ts              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¶æ„è¯„ä»·**: â­â­â­â˜†â˜† (3/5)

- âœ… **æŠ€æœ¯æ ˆç°ä»£**: React 18 + TypeScript + Zustand + Vite
- âœ… **çŠ¶æ€ç®¡ç†**: Zustand + persist/devtools ä¸­é—´ä»¶
- âš ï¸ **ç»„ä»¶è¿‡å¤§**: MainLayout.tsx (271è¡Œ) åŒ…å«è¿‡å¤šé€»è¾‘
- âš ï¸ **ç±»å‹é‡å¤**: å‰ç«¯/åç«¯ç±»å‹æœªå…±äº«ï¼Œæ‰‹åŠ¨ç»´æŠ¤
- âš ï¸ **TODOé—ç•™**: 5ä¸ªTODOæ ‡è®°å¾…å¤„ç†

---

## ğŸ” äºŒã€å‘ç°çš„é—®é¢˜

### 2.1 åç«¯é—®é¢˜ (Rust)

| ä¼˜å…ˆçº§    | é—®é¢˜ç±»å‹       | ä½ç½®                 | æè¿°                                                         | å½±å“                 |
| --------- | -------------- | -------------------- | ------------------------------------------------------------ | -------------------- |
| ğŸ”´ **é«˜** | **å¤æ‚å‡½æ•°**   | `main.rs:37-86`      | `init_app_internal` 86è¡Œï¼Œå«æ•°æ®åº“åˆå§‹åŒ–ã€ç”¨æˆ·åˆ›å»ºã€æœåŠ¡å¯åŠ¨ | å¯ç»´æŠ¤æ€§å·®ï¼Œæµ‹è¯•å›°éš¾ |
| ğŸ”´ **é«˜** | **ä»£ç é‡å¤**   | å¤šä¸ªæ–‡ä»¶             | `map_err_to_frontend()` æ¨¡å¼åœ¨IPCå±‚é‡å¤                      | é”™è¯¯å¤„ç†ä¸ä¸€è‡´       |
| ğŸ”´ **é«˜** | **TODOé—ç•™**   | 8ä¸ªæ–‡ä»¶              | 12ä¸ªTODOæ ‡è®°ï¼ŒåŒ…æ‹¬æ–‡ä»¶ä¼ è¾“ã€æµ‹è¯•ç¦ç”¨                         | åŠŸèƒ½æœªå®Œæˆ           |
| ğŸŸ¡ **ä¸­** | **å¤§å‹æ–‡ä»¶**   | `main.rs` (431è¡Œ)    | åŒ…å«åˆå§‹åŒ–ã€å‘½ä»¤ã€äº‹ä»¶å¾ªç¯ã€è¾…åŠ©å‡½æ•°                         | è¿åå•ä¸€èŒè´£         |
| ğŸŸ¡ **ä¸­** | **é”™è¯¯å¤„ç†**   | `error.rs:63`        | `TransferStateError` è½¬æ¢ç‰¹å®šäºä¸€ä¸ªæ¨¡å—                      | åº”æ›´é€šç”¨åŒ–           |
| ğŸŸ¡ **ä¸­** | **æœªä½¿ç”¨ä»£ç ** | `utils/serde/mod.rs` | `//! TODO: æŒ‰éœ€æ·»åŠ åºåˆ—åŒ–è¾…åŠ©å‡½æ•°`                           | ç©ºæ¨¡å—               |
| ğŸŸ¢ **ä½** | **æ³¨é‡Šç¼ºå¤±**   | `types.rs`           | éƒ¨åˆ†å¤æ‚ç±»å‹ç¼ºå°‘æ–‡æ¡£æ³¨é‡Š                                     | å¯è¯»æ€§               |

#### è¯¦ç»†é—®é¢˜åˆ—è¡¨

**é—®é¢˜ 1: main.rs è¿‡äºåºå¤§ (431è¡Œ)**

```rust
// src-tauri/src/main.rs
// åŒ…å«ï¼š
// - init_app_internal (86è¡Œé€»è¾‘)
// - start_background_services (45è¡Œé€»è¾‘)
// - event_loop (20è¡Œ)
// - handle_network_event (75è¡Œ)
// - 12ä¸ªå‘½ä»¤å¤„ç†å‡½æ•°
```

**é—®é¢˜ 2: é”™è¯¯å¤„ç†é‡å¤æ¨¡å¼**

```rust
// åœ¨ ipc/chat.rs, ipc/file.rs, ipc/contact.rs ä¸­é‡å¤å‡ºç°ï¼š
ChatService::get_messages(db, session_type, target_id, page, page_size)
    .await
    .map_err_to_frontend()  // é‡å¤è°ƒç”¨
```

**é—®é¢˜ 3: TODO æ ‡è®° (12ä¸ª)**

```rust
// src-tauri/src/ipc/file.rs:127
// TODO: å®ç°è¿›åº¦å›è°ƒ

// src-tauri/src/ipc/file.rs:140
// TODO: å®ç°æ¥æ”¶é€»è¾‘

// src-tauri/src/core/chat/sender.rs:219
// TODO: å®ç° ChatMessageHandler::find_by_status

// src-tauri/src/core/chat/receipt.rs:180
// TODO: æ”¹è¿›äº‹ä»¶ç»“æ„ä»¥ä¼ é€’å‘é€è€…åœ°å€

// src-tauri/src/network/feiq/model.rs:76
/// TODO: Remove IPMsg variant once ProtocolPacket is fully removed

// ç­‰ç­‰...
```

### 2.2 å‰ç«¯é—®é¢˜ (TypeScript/React)

| ä¼˜å…ˆçº§    | é—®é¢˜ç±»å‹     | ä½ç½®                    | æè¿°                                                      | å½±å“         |
| --------- | ------------ | ----------------------- | --------------------------------------------------------- | ------------ |
| ğŸ”´ **é«˜** | **å¤æ‚ç»„ä»¶** | `MainLayout.tsx:28-270` | 271è¡Œï¼Œå«15ä¸ªçŠ¶æ€ç®¡ç†ã€11ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°                   | éš¾ä»¥ç»´æŠ¤æµ‹è¯• |
| ğŸ”´ **é«˜** | **é­”æ³•æ•°å­—** | `chatStore.ts`          | æ¶ˆæ¯çŠ¶æ€ä½¿ç”¨æ•°å­— `0, 1, 2, -1`                            | å¯è¯»æ€§å·®     |
| ğŸ”´ **é«˜** | **ç¡¬ç¼–ç å€¼** | `MessageList.tsx:25`    | `currentUserId = 0` ç¡¬ç¼–ç                                 | é€»è¾‘é”™è¯¯é£é™© |
| ğŸŸ¡ **ä¸­** | **ç±»å‹é‡å¤** | å‰åç«¯                  | `UserInfo`, `ChatMessage` åœ¨å‰åç«¯åˆ†åˆ«å®šä¹‰                | åŒæ­¥å›°éš¾     |
| ğŸŸ¡ **ä¸­** | **TODOé—ç•™** | 5ä¸ªæ–‡ä»¶                 | IPCæ¥å£å¾…å®Œå–„ã€Toasté›†æˆ                                  | åŠŸèƒ½ä¸å®Œæ•´   |
| ğŸŸ¡ **ä¸­** | **ä»£ç é‡å¤** | `userStore.ts`          | Mapéå†é€»è¾‘é‡å¤ï¼ˆ`findOnlineUser`, `findOnlineUserById`ï¼‰ | DRYåŸåˆ™      |
| ğŸŸ¢ **ä½** | **æ³¨é‡Šé£æ ¼** | å¤šä¸ªæ–‡ä»¶                | ä¸­è‹±æ–‡æ³¨é‡Šæ··æ‚                                            | ä¸€è‡´æ€§       |

#### è¯¦ç»†é—®é¢˜åˆ—è¡¨

**é—®é¢˜ 1: MainLayout ç»„ä»¶è¿‡äºå¤æ‚**

```typescript
// src/components/MainLayout/MainLayout.tsx
// 271è¡Œï¼ŒåŒ…å«ï¼š
// - 6ä¸ªuseState
// - 3ä¸ªuseEffect
// - 11ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°
// - å¤æ‚çš„æ¡ä»¶æ¸²æŸ“é€»è¾‘
```

**é—®é¢˜ 2: é­”æ³•æ•°å­—æ³›æ»¥**

```typescript
// src/store/chatStore.ts
get().updateMessageStatus(message.mid, 1); // 1 = å·²å‘é€ï¼Ÿ
get().updateMessageStatus(message.mid, -1); // -1 = å¤±è´¥ï¼Ÿ

// åº”è¯¥ä½¿ç”¨æšä¸¾ï¼š
MessageStatus.SENT;
MessageStatus.FAILED;
```

**é—®é¢˜ 3: ç±»å‹å®šä¹‰é‡å¤**

```typescript
// å‰ç«¯: src/types/user.ts
export interface UserInfo {
  uid: number;
  nickname: string;
  // ...
}

// åç«¯: src-tauri/src/types.rs
#[derive(Serialize, Deserialize)]
pub struct UserInfo {
  pub uid: i64,
  pub nickname: String,
  // ...
}
```

---

## ğŸ¯ ä¸‰ã€é‡æ„è®¡åˆ’

### é˜¶æ®µ 1: åç«¯é‡æ„ (Rust)

#### ä»»åŠ¡ 1.1: æ‹†åˆ† main.rs æ¨¡å— [ğŸ”´ é«˜ä¼˜å…ˆçº§]

**ç›®æ ‡**: å°† 431 è¡Œçš„ main.rs æ‹†åˆ†ä¸ºå¤šä¸ªèŒè´£å•ä¸€çš„æ¨¡å—

**å½“å‰çŠ¶æ€**:

- æ–‡ä»¶: `src-tauri/src/main.rs` (431è¡Œ)
- åŒ…å«: åˆå§‹åŒ–ã€å‘½ä»¤ã€äº‹ä»¶å¤„ç†ã€è¾…åŠ©å‡½æ•°

**é‡æ„æ–¹æ¡ˆ**:

```
src-tauri/src/
â”œâ”€â”€ main.rs (50è¡Œ - ä»…å…¥å£)
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ mod.rs (æ¨¡å—å¯¼å‡º)
â”‚   â”œâ”€â”€ init.rs (åˆå§‹åŒ–é€»è¾‘)
â”‚   â””â”€â”€ commands.rs (Tauriå‘½ä»¤æ³¨å†Œ)
â””â”€â”€ event/
    â”œâ”€â”€ handlers.rs (äº‹ä»¶å¤„ç†å™¨)
    â””â”€â”€ mod.rs
```

**å…·ä½“æ”¹åŠ¨**:

1. åˆ›å»º `src-tauri/src/app/init.rs` - åº”ç”¨åˆå§‹åŒ–é€»è¾‘
2. åˆ›å»º `src-tauri/src/app/commands.rs` - å‘½ä»¤å¤„ç†å‡½æ•°
3. åˆ›å»º `src-tauri/src/event/handlers.rs` - ç½‘ç»œ/UIäº‹ä»¶å¤„ç†
4. ç®€åŒ– `main.rs` ä¸ºå…¥å£æ–‡ä»¶

**é¢„è®¡å½±å“**: 15ä¸ªæ–‡ä»¶ä¿®æ”¹
**é¢„è®¡æ—¶é—´**: 2-3å°æ—¶

---

#### ä»»åŠ¡ 1.2: ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼ [ğŸ”´ é«˜ä¼˜å…ˆçº§]

**ç›®æ ‡**: æ¶ˆé™¤IPCå±‚çš„é‡å¤é”™è¯¯å¤„ç†ä»£ç 

**å½“å‰çŠ¶æ€**:

```rust
// åœ¨å¤šä¸ªIPCæ–‡ä»¶ä¸­é‡å¤ï¼š
ChatService::get_messages(db, session_type, target_id, page, page_size)
    .await
    .map_err_to_frontend()
```

**é‡æ„æ–¹æ¡ˆ**:

1. åˆ›å»ºå®æˆ–åŒ…è£…å‡½æ•°ç»Ÿä¸€å¤„ç†
2. åœ¨ `error.rs` ä¸­æ·»åŠ  IPC é”™è¯¯å¤„ç†è¾…åŠ©å‡½æ•°

**ä»£ç ç¤ºä¾‹**:

```rust
// src-tauri/src/error.rs
pub trait IpcResult<T> {
    fn to_ipc_result(self) -> Result<T, String>;
}

impl<T, E: Into<AppError>> IpcResult<T> for Result<T, E> {
    fn to_ipc_result(self) -> Result<T, String> {
        self.map_err(|e| FrontendError::from(e.into()).to_json())
    }
}
```

**é¢„è®¡å½±å“**: 8ä¸ªIPCæ–‡ä»¶
**é¢„è®¡æ—¶é—´**: 1å°æ—¶

---

#### ä»»åŠ¡ 1.3: å®ç°å¾…å®Œæˆçš„ TODO [ğŸ”´ é«˜ä¼˜å…ˆçº§]

**TODOæ¸…å•**:

| æ–‡ä»¶                   | è¡Œå· | TODOå†…å®¹            | ä¼˜å…ˆçº§ |
| ---------------------- | ---- | ------------------- | ------ |
| `ipc/file.rs`          | 127  | å®ç°è¿›åº¦å›è°ƒ        | é«˜     |
| `ipc/file.rs`          | 140  | å®ç°æ¥æ”¶é€»è¾‘        | é«˜     |
| `core/chat/sender.rs`  | 219  | å®ç° find_by_status | ä¸­     |
| `core/chat/receipt.rs` | 180  | æ”¹è¿›äº‹ä»¶ç»“æ„        | ä¸­     |
| `utils/serde/mod.rs`   | 5    | æ·»åŠ åºåˆ—åŒ–è¾…åŠ©      | ä½     |

**é¢„è®¡æ—¶é—´**: 3-4å°æ—¶

---

#### ä»»åŠ¡ 1.4: ä¼˜åŒ–äº‹ä»¶å¾ªç¯æ€§èƒ½ [ğŸŸ¡ ä¸­ä¼˜å…ˆçº§]

**ç›®æ ‡**: ä¼˜åŒ– `handle_network_event` ä¸­çš„åŒ¹é…é€»è¾‘

**å½“å‰é—®é¢˜**:

```rust
// main.rs:259-335
async fn handle_network_event(...) {
    match event {
        NetworkEvent::UserOnline { ... } => { ... }
        NetworkEvent::UserOffline { ... } => { ... }
        // ... 11ä¸ªå˜ä½“
    }
}
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:

1. ä½¿ç”¨ç­–ç•¥æ¨¡å¼æˆ–å¤„ç†å™¨æ³¨å†Œè¡¨
2. æ¯ä¸ªäº‹ä»¶ç±»å‹ç‹¬ç«‹å¤„ç†å™¨

**é¢„è®¡å½±å“**: 2ä¸ªæ–‡ä»¶
**é¢„è®¡æ—¶é—´**: 1.5å°æ—¶

---

### é˜¶æ®µ 2: å‰ç«¯é‡æ„ (React/TypeScript)

#### ä»»åŠ¡ 2.1: æ‹†åˆ† MainLayout ç»„ä»¶ [ğŸ”´ é«˜ä¼˜å…ˆçº§]

**ç›®æ ‡**: å°† 271 è¡Œçš„ MainLayout æ‹†åˆ†ä¸ºæ›´å°ã€å¯æµ‹è¯•çš„ç»„ä»¶

**å½“å‰çŠ¶æ€**:

- æ–‡ä»¶: `src/components/MainLayout/MainLayout.tsx` (271è¡Œ)
- çŠ¶æ€: 6ä¸ª useState
- å‡½æ•°: 11ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°

**é‡æ„æ–¹æ¡ˆ**:

```
src/components/MainLayout/
â”œâ”€â”€ MainLayout.tsx (80è¡Œ - ä»…å¸ƒå±€å’ŒçŠ¶æ€åè°ƒ)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Sidebar.tsx (æ ‡ç­¾é¡µ + åˆ—è¡¨å®¹å™¨)
â”‚   â”œâ”€â”€ ContactPanel.tsx (é€šè®¯å½•é¢æ¿)
â”‚   â””â”€â”€ ChatPanel.tsx (èŠå¤©é¢æ¿)
â””â”€â”€ hooks/
    â””â”€â”€ useLayoutState.ts (çŠ¶æ€ç®¡ç†é€»è¾‘)
```

**ä»£ç æå–ç¤ºä¾‹**:

```typescript
// useLayoutState.ts - æå–çŠ¶æ€ç®¡ç†é€»è¾‘
export function useLayoutState() {
  const [layoutState, setLayoutState] = useState<LayoutState>(...);
  const [createGroupDialogOpen, setCreateGroupDialogOpen] = useState(false);

  const handleSessionSelect = useCallback((sessionId, userId) => {
    // ... é€»è¾‘
  }, [...]);

  return {
    layoutState,
    createGroupDialogOpen,
    handleSessionSelect,
    // ...
  };
}
```

**é¢„è®¡å½±å“**: 4ä¸ªæ–°æ–‡ä»¶ + 1ä¸ªä¿®æ”¹
**é¢„è®¡æ—¶é—´**: 2å°æ—¶

---

#### ä»»åŠ¡ 2.2: æ¶ˆé™¤é­”æ³•æ•°å­— [ğŸ”´ é«˜ä¼˜å…ˆçº§]

**ç›®æ ‡**: å°†ç¡¬ç¼–ç çš„çŠ¶æ€ç æ›¿æ¢ä¸ºæšä¸¾

**å½“å‰é—®é¢˜ä½ç½®**:

```typescript
// src/store/chatStore.ts
set({ isLoadingSessions: false }); // ç­‰ç­‰
get().updateMessageStatus(message.mid, 1); // é­”æ³•æ•°å­—
get().updateMessageStatus(message.mid, -1); // é­”æ³•æ•°å­—
```

**é‡æ„æ–¹æ¡ˆ**:

```typescript
// src/types/enums.ts
export enum MessageStatus {
  SENDING = 0,
  SENT = 1,
  READ = 2,
  FAILED = -1,
}

export enum SessionType {
  SINGLE = 0,
  GROUP = 1,
}
```

**æ›¿æ¢ä½ç½®**:

- `chatStore.ts`: 6å¤„
- `MessageItem.tsx`: 2å¤„
- `ChatWindow.tsx`: 3å¤„

**é¢„è®¡å½±å“**: 5ä¸ªæ–‡ä»¶
**é¢„è®¡æ—¶é—´**: 1å°æ—¶

---

#### ä»»åŠ¡ 2.3: ä¿®å¤ç¡¬ç¼–ç å€¼ [ğŸ”´ é«˜ä¼˜å…ˆçº§]

**ç›®æ ‡**: ä¿®å¤ `currentUserId = 0` ç¡¬ç¼–ç é—®é¢˜

**å½“å‰é—®é¢˜**:

```typescript
// src/components/ChatWindow/MessageList.tsx:25
interface Props {
  currentUserId = 0, // TODO: ä»ç”¨æˆ·çŠ¶æ€è·å–
}
```

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
// é€šè¿‡ props æˆ– context ä¼ å…¥çœŸå®ç”¨æˆ·ID
interface Props {
  currentUserId: number; // å¿…é¡»ä¼ å…¥
}

// åœ¨çˆ¶ç»„ä»¶ä¸­è·å–
const { currentUser } = useUserStore();
<MessageList currentUserId={currentUser?.uid} />
```

**é¢„è®¡å½±å“**: 3ä¸ªæ–‡ä»¶
**é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ

---

#### ä»»åŠ¡ 2.4: ç»Ÿä¸€ç±»å‹å®šä¹‰ [ğŸŸ¡ ä¸­ä¼˜å…ˆçº§]

**ç›®æ ‡**: åˆ›å»ºå…±äº«ç±»å‹å®šä¹‰ï¼Œå‡å°‘å‰åç«¯ç±»å‹é‡å¤

**æ–¹æ¡ˆ**:

1. ä½¿ç”¨ Tauri çš„ç”Ÿæˆç±»å‹åŠŸèƒ½
2. æˆ–è€…åˆ›å»ºå…±äº«ç±»å‹æ–‡ä»¶

**é¢„è®¡æ—¶é—´**: 1.5å°æ—¶

---

#### ä»»åŠ¡ 2.5: å®Œæˆ TODO æ ‡è®° [ğŸŸ¡ ä¸­ä¼˜å…ˆçº§]

**TODOæ¸…å•**:

| æ–‡ä»¶             | è¡Œå· | TODOå†…å®¹       | ä¼˜å…ˆçº§ |
| ---------------- | ---- | -------------- | ------ |
| `ipc/index.ts`   | 2    | å®Œå–„IPCæ¥å£    | ä¸­     |
| `ipc/contact.ts` | 2    | å®Œå–„è”ç³»äººæ¥å£ | ä¸­     |
| `ipc/chat.ts`    | 2    | å®Œå–„èŠå¤©æ¥å£   | ä¸­     |
| `utils/error.ts` | 115  | é›†æˆToasté€šçŸ¥  | ä½     |

**é¢„è®¡æ—¶é—´**: 2å°æ—¶

---

## ğŸ“Š å››ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 4.1 åç«¯ä¼˜åŒ–

| ä¼˜åŒ–é¡¹       | å½“å‰é—®é¢˜       | å»ºè®®æ–¹æ¡ˆ     | é¢„æœŸæ”¶ç›Š |
| ------------ | -------------- | ------------ | -------- |
| æ•°æ®åº“è¿æ¥æ±  | ä½¿ç”¨å•ä¸ªè¿æ¥   | å®ç°è¿æ¥æ±    | å¹¶å‘æå‡ |
| æ¶ˆæ¯åºåˆ—åŒ–   | æ¯æ¬¡è§£æéƒ½åˆ†é… | ä½¿ç”¨å¯¹è±¡æ±    | å‡å°‘GC   |
| äº‹ä»¶å¤„ç†     | å•çº¿ç¨‹å¤„ç†     | è€ƒè™‘å¹¶è¡Œå¤„ç† | ååé‡â†‘  |
| UDPç¼“å†²åŒº    | é»˜è®¤å¤§å°       | è°ƒä¼˜ç¼“å†²åŒº   | ä¸¢åŒ…ç‡â†“  |

### 4.2 å‰ç«¯ä¼˜åŒ–

| ä¼˜åŒ–é¡¹     | å½“å‰é—®é¢˜       | å»ºè®®æ–¹æ¡ˆ   | é¢„æœŸæ”¶ç›Š  |
| ---------- | -------------- | ---------- | --------- |
| ç»„ä»¶é‡æ¸²æŸ“ | å¤§ç»„ä»¶é¢‘ç¹æ¸²æŸ“ | æ‹†åˆ†+memo  | æ¸²æŸ“æ€§èƒ½â†‘ |
| æ¶ˆæ¯åˆ—è¡¨   | å…¨éƒ¨æ¸²æŸ“       | è™šæ‹Ÿåˆ—è¡¨   | å†…å­˜â†“     |
| çŠ¶æ€è®¢é˜…   | è®¢é˜…æ•´ä¸ªstore  | é€‰æ‹©å™¨ä¼˜åŒ– | é‡æ¸²æŸ“â†“   |
| å›¾ç‰‡åŠ è½½   | æ— æ‡’åŠ è½½       | å®ç°æ‡’åŠ è½½ | é¦–å±â†‘     |

---

## ğŸ“ äº”ã€é‡æ„æ‰§è¡Œæ£€æŸ¥æ¸…å•

### é€šç”¨è¦æ±‚

- [ ] æ¯ä¸ªé‡æ„ä»»åŠ¡å¿…é¡»æœ‰ç‹¬ç«‹çš„æ–‡æ¡£
- [ ] é‡æ„å‰ç¼–å†™æµ‹è¯•ï¼ˆå¦‚æœç¼ºå¤±ï¼‰
- [ ] é€æ­¥é‡æ„ï¼Œæ¯æ¬¡æäº¤ä¸€ä¸ªé€»è¾‘å•å…ƒ
- [ ] ä¿æŒå‘åå…¼å®¹æ€§ï¼ˆé™¤éç ´åæ€§å˜æ›´å¿…è¦ï¼‰
- [ ] é‡æ„åè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
- [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£ï¼ˆREADMEã€APIæ–‡æ¡£ï¼‰

### Rust ç‰¹å®šè¦æ±‚

- [ ] `cargo check` é€šè¿‡
- [ ] `cargo clippy` æ— è­¦å‘Š
- [ ] `cargo fmt` æ ¼å¼åŒ–
- [ ] `cargo test` æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ–‡æ¡£æµ‹è¯•é€šè¿‡

### TypeScript ç‰¹å®šè¦æ±‚

- [ ] `bunx tsc --noEmit` æ— ç±»å‹é”™è¯¯
- [ ] `bun run lint` æ— ESLintè­¦å‘Š
- [ ] `bun run format` æ ¼å¼åŒ–
- [ ] `bun test` æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## ğŸ“… å…­ã€æ—¶é—´ä¼°ç®—

| é˜¶æ®µ     | ä»»åŠ¡æ•° | é¢„è®¡æ—¶é—´      | ä¼˜å…ˆçº§ |
| -------- | ------ | ------------- | ------ |
| åç«¯é‡æ„ | 4      | 8-10å°æ—¶      | P0     |
| å‰ç«¯é‡æ„ | 5      | 7-8å°æ—¶       | P1     |
| æ€§èƒ½ä¼˜åŒ– | 2      | 4-5å°æ—¶       | P2     |
| **æ€»è®¡** | **11** | **19-23å°æ—¶** | -      |

---

## ğŸ“ ä¸ƒã€ä»£ç è´¨é‡æŒ‡æ ‡

### é‡æ„å‰

| æŒ‡æ ‡                | æ•°å€¼   | è¯„çº§      |
| ------------------- | ------ | --------- |
| åç«¯ä»£ç è¡Œæ•°        | ~8,000 | -         |
| å‰ç«¯ä»£ç è¡Œæ•°        | ~3,500 | -         |
| å¹³å‡æ–‡ä»¶è¡Œæ•° (åç«¯) | 103    | âš ï¸ åé«˜   |
| å¹³å‡æ–‡ä»¶è¡Œæ•° (å‰ç«¯) | 66     | âœ… è‰¯å¥½   |
| TODO æ•°é‡           | 17     | ğŸ”´ éœ€å¤„ç† |
| å¤æ‚å‡½æ•° (>50è¡Œ)    | 6      | ğŸ”´ éœ€æ‹†åˆ† |
| æµ‹è¯•è¦†ç›–ç‡          | æœªçŸ¥   | âš ï¸ éœ€è¯„ä¼° |

### é‡æ„ç›®æ ‡

| æŒ‡æ ‡                | ç›®æ ‡ | æå‡  |
| ------------------- | ---- | ----- |
| å¹³å‡æ–‡ä»¶è¡Œæ•° (åç«¯) | <80  | -23%  |
| TODO æ•°é‡           | 0    | -100% |
| å¤æ‚å‡½æ•° (>50è¡Œ)    | 2    | -67%  |
| æµ‹è¯•è¦†ç›–ç‡          | >60% | +?%   |

---

## ğŸš¦ å…«ã€é£é™©è¯„ä¼°

| é£é™©        | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½               |
| ----------- | ------ | ---- | ---------------------- |
| å¼•å…¥å›å½’bug | ä¸­     | é«˜   | å……åˆ†æµ‹è¯•ã€å°æ­¥æäº¤     |
| åŠŸèƒ½ä¸­æ–­    | ä½     | é«˜   | ä¿ç•™åŸä»£ç åˆ†æ”¯         |
| æ—¶é—´è¶…æ”¯    | ä¸­     | ä¸­   | åˆ†é˜¶æ®µå®æ–½ã€ä¼˜å…ˆçº§æ’åº |
| å›¢é˜Ÿé€‚åº”    | ä½     | ä½   | ä»£ç å®¡æŸ¥ã€æ–‡æ¡£         |

---

## ğŸ“š ä¹ã€å‚è€ƒèµ„æº

### æ–‡æ¡£

- [Rust API Guidelines](https://rust-lang.github.io/api-guidelines/)
- [React Best Practices](https://react.dev/learn)
- [Tauri Documentation](https://tauri.app/)

### å·¥å…·

- `cargo clippy` - Rust é™æ€åˆ†æ
- `cargo fmt` - Rust æ ¼å¼åŒ–
- `bun run lint` - ESLint
- `bunx tsc` - TypeScript ç±»å‹æ£€æŸ¥

---

## âœ… åã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¼€å§‹**: ä»»åŠ¡ 1.1 (æ‹†åˆ† main.rs)
2. **å¹¶è¡Œè¿›è¡Œ**: ä»»åŠ¡ 2.1 (æ‹†åˆ† MainLayout)
3. **æœ¬å‘¨å®Œæˆ**: æ‰€æœ‰ ğŸ”´ é«˜ä¼˜å…ˆçº§ä»»åŠ¡
4. **ä¸‹å‘¨å®Œæˆ**: æ‰€æœ‰ ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ä»»åŠ¡
5. **æŒç»­æ”¹è¿›**: ä»£ç å®¡æŸ¥ä¸­æŒç»­å‘ç°ä¼˜åŒ–ç‚¹

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-01  
**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: å¾…æ‰§è¡Œ
